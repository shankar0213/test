import paramiko
import pandas as pd

# Function to establish SSH connection
def establish_ssh_connection(host, user, password, port=22):
    try:
        ssh_client = paramiko.SSHClient()
        ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh_client.connect(host, port=port, username=user, password=password)
        print("âœ… SSH Connection Established")
        return ssh_client
    except Exception as e:
        print(f"âŒ SSH connection failed: {e}")
        return None

# Function to run Beeline query and download result as CSV
def run_beeline_and_download_csv(ssh_client, query, remote_csv="/tmp/hive_output.csv", local_csv="hive_output.csv"):
    try:
        username = ssh_client.get_transport().get_username()

        # Build the Beeline command
        beeline_cmd = f'beeline -n {username} --outputformat=csv2 -e "{query}" > {remote_csv}'

        # Run Beeline remotely
        stdin, stdout, stderr = ssh_client.exec_command(beeline_cmd)
        exit_status = stdout.channel.recv_exit_status()

        error = stderr.read().decode().strip()
        if exit_status != 0 or "ERROR" in error.upper():
            print(f"âš ï¸ Beeline failed:\n{error}")
            return None

        # Download the file via SFTP
        sftp = ssh_client.open_sftp()
        sftp.get(remote_csv, local_csv)
        sftp.remove(remote_csv)
        sftp.close()

        print(f"ðŸ“¥ Downloaded CSV to: {local_csv}")
        return local_csv

    except Exception as e:
        print(f"âŒ Error during Beeline or download: {e}")
        return None

# Main script logic
def main():
    print("ðŸ” SSH to Hive Server")

    # --- SSH DETAILS ---
    ssh_host = input("Hostname/IP: ").strip()
    ssh_user = input("Username: ").strip()
    ssh_password = input("Password: ").strip()
    ssh_port = 22  # Or customize if needed

    # Connect via SSH
    ssh_client = establish_ssh_connection(ssh_host, ssh_user, ssh_password, ssh_port)
    if not ssh_client:
        return

    # --- QUERY INPUT ---
    print("\nðŸ“¥ Enter your Hive query (end with a semicolon `;`):")
    query = input().strip()

    # Run Beeline and get CSV
    local_csv_path = run_beeline_and_download_csv(ssh_client, query)

    # Load into pandas DataFrame
    if local_csv_path:
        try:
            df = pd.read_csv(local_csv_path)
            print("\nðŸ“Š Query Results:")
            print(df)
        except Exception as e:
            print(f"âŒ Failed to read CSV: {e}")

    # Close SSH
    ssh_client.close()
    print("ðŸ”’ SSH connection closed.")

if __name__ == "__main__":
    main()






--------------
py 11

PS C:\Users\bankid\Music> venv\Scripts\python.exe -c "import platform; print(platform.python_version()); print(platform.architecture())"


PS C:\Users\bankid\Music> py -3.11 -m venv venv
   
PS C:\Users\bankid\Music> venv\Scripts\pip.exe install pandas --trusted-host pypi.org --trusted-host files.pythonhosted.org --trusted-host pypi.python.org
PS C:\Users\bankid\Music> venv\Scripts\python.exe test1.py

