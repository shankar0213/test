import paramiko
import pandas as pd
import getpass

def establish_ssh_connection(host, user, password, port):
    try:
        ssh_client = paramiko.SSHClient()
        ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh_client.connect(host, port=port, username=user, password=password)
        return ssh_client
    except Exception as e:
        print(f"âŒ Connection failed: {e}")
        return None

def run_beeline_query(ssh_client, query):
    try:
        query_file_path = "/tmp/query_script.sql"

        # Hive settings to ensure clean output
        hive_settings = """\
set hive.cli.print.header=true;
set hive.fetch.task.conversion=none;
set hive.optimize.skewjoin=false;
set hive.limit.optimize.enable=false;
set hive.support.quoted.identifiers=none;
"""
        full_query = hive_settings + "\n" + query

        # Write query to remote file
        sftp = ssh_client.open_sftp()
        with sftp.open(query_file_path, "w") as f:
            f.write(full_query)
        sftp.close()

        # Run beeline command
        beeline_cmd = (
            f"beeline -S --outputformat=tsv2 --verbose=false --silent=true "
            f"-n {ssh_client.get_transport().get_username()} -f {query_file_path}"
        )
        stdin, stdout, stderr = ssh_client.exec_command(beeline_cmd)

        output = stdout.read().decode()
        error = stderr.read().decode()

        if error.strip():
            print(f"âš ï¸ Beeline stderr output:\n{error.strip()}")

        # Combine both stdout and stderr if needed
        full_output = output.strip().splitlines()

        # Filter out noise lines (like SLF4J, warnings, etc.)
        clean_lines = [
            line for line in full_output
            if line.strip() and not line.startswith(("SLF4J", "WARNING", "log4j", "Picked up"))
        ]

        # Detect header (first line with tabs and no known log keywords)
        header_idx = None
        for i, line in enumerate(clean_lines):
            if '\t' in line and not any(word in line for word in ['SLF4J', 'WARNING', 'log4j']):
                header_idx = i
                break

        if header_idx is None:
            print("âš ï¸ Could not find header row in output.")
            return None

        headers = clean_lines[header_idx].split('\t')
        data_lines = clean_lines[header_idx + 1:]
        data = [line.split('\t') for line in data_lines if line.strip()]

        if not data:
            print("âš ï¸ No data rows found after header.")
            return None

        df = pd.DataFrame(data, columns=headers)

        # Clean up remote temp query file
        ssh_client.exec_command(f"rm {query_file_path}")

        return df

    except Exception as e:
        print(f"âŒ Error executing query: {e}")
        return None

def main():
    print("ðŸ” SSH to Hive Server")

    ssh_host = input("SSH Host: ").strip()
    ssh_user = input("SSH Username: ").strip()
    ssh_password = getpass.getpass("SSH Password: ")
    ssh_port_input = input("SSH Port (default 22): ").strip()
    ssh_port = int(ssh_port_input) if ssh_port_input else 22

    ssh_client = establish_ssh_connection(ssh_host, ssh_user, ssh_password, ssh_port)
    if not ssh_client:
        return

    print("âœ… SSH Connection Established")

    print("\nðŸ“¥ Enter your Hive query (end with a semicolon `;`):")
    query_lines = []
    while True:
        line = input()
        query_lines.append(line)
        if line.strip().endswith(';'):
            break
    query = "\n".join(query_lines)

    df = run_beeline_query(ssh_client, query)
    if df is not None:
        print("\nðŸ“Š Query Results:")
        print(df.to_string(index=False))
    else:
        print("âš ï¸ Query returned no results or failed.")

    ssh_client.close()
    print("ðŸ”’ SSH connection closed.")

if __name__ == "__main__":
    main()




--------------
py 11

PS C:\Users\bankid\Music> venv\Scripts\python.exe -c "import platform; print(platform.python_version()); print(platform.architecture())"


PS C:\Users\bankid\Music> py -3.11 -m venv venv
   
PS C:\Users\bankid\Music> venv\Scripts\pip.exe install pandas --trusted-host pypi.org --trusted-host files.pythonhosted.org --trusted-host pypi.python.org
PS C:\Users\bankid\Music> venv\Scripts\python.exe test1.py

